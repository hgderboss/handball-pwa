<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handball Statistik</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 0;
        position: relative;
        background-color: white;
    }
    /* Wasserzeichen-Logo auf allen Seiten */
    body::before {
        content: "";
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40vw;
        height: auto;
        background-image: url('logo.png.JPG');
        background-repeat: no-repeat;
        background-position: center center;
        background-size: contain;
        opacity: 0.08;
        z-index: -1;
        pointer-events: none;
    }
    h1 { text-align: center; }
    .player-card { 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        padding: 10px; 
        margin: 10px; 
        flex: 1; 
        min-width: 250px; 
        background: rgba(255, 255, 255, 0.9);
    }
    .player-name { 
        font-weight: bold; 
        font-size: 1.4em; 
        text-align: center; 
        margin-bottom: 10px; 
    }
    .grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .btn { 
        width: 48%; 
        padding: 15px; 
        margin: 2px 1%; 
        border: none; 
        cursor: pointer; 
        font-size: 1.1em; 
        border-radius: 5px; 
        user-select: none;
    }
    .positive { background-color: #d4edda; }
    .negative { background-color: #f8d7da; }
    .btn.full-width { width: 98%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .thick-separator { border-left: 3px solid black; }
    .export-buttons { margin-top: 20px; }
    .hidden { display: none; }
    /* Erste Seite voller wei√üer Hintergrund */
    #setup { 
        background: rgba(255, 255, 255, 0.95); 
        padding: 20px; 
        border-radius: 10px; 
        max-width: 100%;
        width: 100%;
        min-height: 100vh;
        box-sizing: border-box;
    }
    #opponent { 
        font-size: 1.3em; 
        padding: 8px; 
        width: 100%; 
        margin-bottom: 15px;
    }
    #player-selection { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: space-between;
    }
    #player-selection label { 
        display: inline-block; 
        width: 48%; 
        font-size: 1.2em; 
        margin-bottom: 5px;
    }
    button.start-btn {
        font-size: 1.4em; 
        padding: 12px 20px; 
        background-color: #009688; /* zum Logo passender Farbton */
        color: white; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
    }
    button.start-btn:hover {
        background-color: #00796b;
    }
</style>
</head>
<body>

<div id="setup">
    <h1>Willkommen!</h1>
    <input type="text" id="opponent" placeholder="Gegner eingeben">
    <div id="player-selection">
        <label><input type="checkbox" value="1"> Spieler 1</label>
        <label><input type="checkbox" value="2"> Spieler 2</label>
        <label><input type="checkbox" value="3"> Spieler 3</label>
        <label><input type="checkbox" value="4"> Spieler 4</label>
        <label><input type="checkbox" value="5"> Spieler 5</label>
        <label><input type="checkbox" value="6"> Spieler 6</label>
        <label><input type="checkbox" value="7"> Spieler 7</label>
        <label><input type="checkbox" value="8"> Spieler 8</label>
        <label><input type="checkbox" value="9"> Spieler 9</label>
        <label><input type="checkbox" value="10"> Spieler 10</label>
        <label><input type="checkbox" value="11"> Spieler 11</label>
        <label><input type="checkbox" value="12"> Spieler 12</label>
        <label><input type="checkbox" value="13"> Spieler 13</label>
        <label><input type="checkbox" value="14"> Spieler 14</label>
        <label><input type="checkbox" value="15"> Spieler 15</label>
        <label><input type="checkbox" value="16"> Spieler 16</label>
        <label><input type="checkbox" value="17"> Spieler 17</label>
        <label><input type="checkbox" value="18"> Spieler 18</label>
        <label><input type="checkbox" value="19"> Spieler 19</label>
        <label><input type="checkbox" value="20"> Spieler 20</label>
    </div>
    <button class="start-btn" onclick="start()">Start</button>
</div>

<h1 id="headline" class="hidden"></h1>
<div id="players" class="grid"></div>

<div id="statsSection" class="hidden">
    <h2>Spieler-Statistik</h2>
    <div class="export-buttons">
        <button onclick="exportTableToExcel('playerTable')">Export Excel</button>
        <button onclick="exportTableToPDF('playerTable')">Export PDF</button>
    </div>
    <div id="playerStats"></div>

    <h2>Team-Statistik</h2>
    <div class="export-buttons">
        <button onclick="exportTableToExcel('teamTable')">Export Excel</button>
        <button onclick="exportTableToPDF('teamTable')">Export PDF</button>
    </div>
    <div id="teamStats"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
    const actionsPositive = ["KM", "DBR", "NAH", "FERN", "TGS", "7M"];
    const actionsNegative = ["KM", "DBR", "NAH", "FERN", "TGS", "7M", "TF"];
    let playersData = {};

    function createButton(player, action, type, fullWidth = false) {
        const btn = document.createElement("button");
        btn.className = `btn ${type} ${fullWidth ? 'full-width' : ''}`;
        btn.innerText = `${action} (0)`;

        let holdTimeout;
        btn.onmousedown = () => {
            holdTimeout = setTimeout(() => {
                playersData[player][action] = Math.max(0, playersData[player][action] - 1);
                btn.innerText = `${action} (${playersData[player][action]})`;
                updateTables();
            }, 500);
        };
        btn.onmouseup = () => {
            if (holdTimeout) {
                clearTimeout(holdTimeout);
                if (Date.now() - lastClickTime < 500) {
                    playersData[player][action]++;
                    btn.innerText = `${action} (${playersData[player][action]})`;
                    updateTables();
                }
            }
        };
        let lastClickTime = Date.now();
        btn.addEventListener("mousedown", () => lastClickTime = Date.now());

        return btn;
    }

    function start() {
        const opponent = document.getElementById("opponent").value;
        const selectedPlayers = Array.from(document.querySelectorAll("#player-selection input:checked"))
            .map(cb => parseInt(cb.value));
        
        document.getElementById("setup").classList.add("hidden");
        document.getElementById("headline").classList.remove("hidden");
        document.getElementById("headline").innerText = `Statistik vs ${opponent}`;
        document.getElementById("statsSection").classList.remove("hidden");

        const playersDiv = document.getElementById("players");
        playersDiv.innerHTML = "";

        selectedPlayers.forEach(num => {
            playersData[num] = {};
            [...actionsPositive, ...actionsNegative].forEach(a => playersData[num][a] = 0);

            const card = document.createElement("div");
            card.className = "player-card";
            card.innerHTML = `<div class="player-name">Spieler ${num}</div>`;

            actionsPositive.forEach(a => card.appendChild(createButton(num, a, 'positive')));
            const sep = document.createElement("div");
            sep.style.borderBottom = "3px solid black";
            sep.style.margin = "5px 0";
            card.appendChild(sep);
            actionsNegative.slice(0, -1).forEach(a => card.appendChild(createButton(num, a, 'negative')));
            card.appendChild(createButton(num, "TF", 'negative', true));

            playersDiv.appendChild(card);
        });

        updateTables();
    }

    function updateTables() {
        let playerTable = "<table id='playerTable'><thead><tr><th rowspan='2'>Spieler</th>" +
            `<th colspan='${actionsPositive.length}'>Positive Aktionen</th>` +
            `<th colspan='${actionsNegative.length}'>Negative Aktionen</th></tr><tr>` +
            actionsPositive.map(a => `<th>${a}</th>`).join("") +
            actionsNegative.map((a,i) => `<th class='${i===0 ? "thick-separator" : ""}'>${a}</th>`).join("") +
            "</tr></thead><tbody>";

        Object.keys(playersData).forEach(num => {
            playerTable += `<tr><td><b>Spieler ${num}</b></td>` +
                actionsPositive.map(a => `<td>${playersData[num][a]}</td>`).join("") +
                actionsNegative.map((a,i) => `<td class='${i===0 ? "thick-separator" : ""}'>${playersData[num][a]}</td>`).join("") +
                "</tr>";
        });

        playerTable += "</tbody></table>";
        document.getElementById("playerStats").innerHTML = playerTable;

        let teamSums = {};
        [...actionsPositive, ...actionsNegative].forEach(a => teamSums[a] = 0);
        Object.values(playersData).forEach(data => {
            Object.keys(data).forEach(a => teamSums[a] += data[a]);
        });

        let teamTable = "<table id='teamTable'><thead><tr><th rowspan='2'>Spieler</th>" +
            `<th colspan='${actionsPositive.length}'>Positive Aktionen</th>` +
            `<th colspan='${actionsNegative.length}'>Negative Aktionen</th></tr><tr>` +
            actionsPositive.map(a => `<th>${a}</th>`).join("") +
            actionsNegative.map((a,i) => `<th class='${i===0 ? "thick-separator" : ""}'>${a}</th>`).join("") +
            "</tr></thead><tbody>";

        teamTable += `<tr><td><b>Team</b></td>` +
            actionsPositive.map(a => `<td>${teamSums[a]}</td>`).join("") +
            actionsNegative.map((a,i) => `<td class='${i===0 ? "thick-separator" : ""}'>${teamSums[a]}</td>`).join("") +
            "</tr></tbody></table>";

        document.getElementById("teamStats").innerHTML = teamTable;
    }

    function exportTableToExcel(tableID) {
        let table = document.getElementById(tableID);
        let wb = XLSX.utils.table_to_book(table, {sheet:"Sheet 1"});
        XLSX.writeFile(wb, `${tableID}.xlsx`);
    }

    function exportTableToPDF(tableID) {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.autoTable({ html: `#${tableID}` });
        doc.save(`${tableID}.pdf`);
    }
</script>

</body>
</html>
