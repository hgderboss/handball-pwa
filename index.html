<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handball Statistik</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 0;
        position: relative;
        background-color: white;
    }
    body::before {
        content: "";
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 60vw;
        height: 60vw;
        max-width: 800px;
        max-height: 800px;
        background-image: url('logo.png.JPG');
        background-repeat: no-repeat;
        background-position: center center;
        background-size: contain;
        opacity: 0.15;
        z-index: -1;
        pointer-events: none;
    }
    h1 { text-align: center; }
    .player-card { 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        padding: 10px; 
        margin: 10px; 
        flex: 1; 
        min-width: 250px; 
        background: rgba(255, 255, 255, 0.9);
    }
    .player-name { 
        font-weight: bold; 
        font-size: 1.4em; 
        text-align: center; 
        margin-bottom: 10px; 
    }
    .grid { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 10px; 
        justify-content: center; 
    }
    .btn { 
        width: 48%; 
        padding: 12px; 
        margin: 2px 1%; 
        border: none; 
        cursor: pointer; 
        font-size: 1em; 
        border-radius: 5px; 
        user-select: none;
    }
    .positive { background-color: #d4edda; }
    .negative { background-color: #f8d7da; }
    .btn.full-width { width: 98%; }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 20px; 
        background-color: white; 
        font-size: 0.9em;
    }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    .thick-separator { border-left: 3px solid black; }
    .export-buttons { margin-top: 20px; }
    .hidden { display: none; }
    #setup { 
        background: rgba(255, 255, 255, 0.95); 
        padding: 20px; 
        border-radius: 10px; 
        max-width: 100%;
        width: 100%;
        min-height: 100vh;
        box-sizing: border-box;
    }
    #opponent { 
        font-size: 1.2em; 
        padding: 8px; 
        width: 100%; 
        margin-bottom: 15px;
    }
    #player-selection { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: space-between;
    }
    #player-selection label { 
        display: inline-block; 
        width: 48%; 
        font-size: 1em; 
        margin-bottom: 5px;
    }
    button.start-btn {
        font-size: 1.3em; 
        padding: 10px 15px; 
        background-color: #009688; 
        color: white; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
    }
    button.start-btn:hover {
        background-color: #00796b;
    }
    @media (max-width: 768px) {
        .btn { 
            width: 100%; 
            font-size: 0.95em;
            padding: 10px;
        }
        .player-card {
            min-width: unset;
            width: 100%;
        }
        #player-selection label { 
            width: 100%; 
            font-size: 1em;
        }
        table {
            font-size: 0.8em;
        }
    }
</style>
</head>
<body>

<div id="setup">
    Gegner: <input type="text" id="opponent" placeholder="Gegner eingeben">
    <br><br>
    <div id="player-selection">
        <script>
            document.write(
                Array.from({length: 20}, (_, i) => 
                    `<label><input type='checkbox' value='${i+1}'> Spieler ${i+1}</label>`
                ).join("")
            );
        </script>
    </div>
    <br>
    <button class="start-btn" onclick="validateAndStart()">Start</button>
</div>

<h1 id="headline" class="hidden"></h1>
<div id="players" class="grid"></div>

<h2>Spieler-Statistik</h2>
<div class="export-buttons">
    <button onclick="exportTableToExcel('playerTable')">Export Excel</button>
    <button onclick="exportTableToPDF('playerTable')">Export PDF</button>
</div>
<div id="playerStats"></div>

<h2>Team-Statistik</h2>
<div class="export-buttons">
    <button onclick="exportTableToExcel('teamTable')">Export Excel</button>
    <button onclick="exportTableToPDF('teamTable')">Export PDF</button>
</div>
<div id="teamStats"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const actionsPositive = ["KM", "DBR", "NAH", "FERN", "TGS", "7M"];
    const actionsNegative = ["KM", "DBR", "NAH", "FERN", "TGS", "7M", "TF"];
    let playersData = {};
    let longPressTimer;

    function validateAndStart() {
        const opponent = document.getElementById("opponent").value.trim();
        const selectedPlayers = Array.from(document.querySelectorAll("#player-selection input:checked"));

        let errors = [];
        if (opponent.length < 3) errors.push("Gegnername (mindestens 3 Buchstaben)");
        if (selectedPlayers.length < 7) errors.push("Mindestens 7 Spieler auswÃ¤hlen");

        if (errors.length > 0) {
            alert("Bitte korrigieren:\n- " + errors.join("\n- "));
            return;
        }
        start();
    }

    function start() {
        const opponent = document.getElementById("opponent").value;
        const selectedPlayers = Array.from(document.querySelectorAll("#player-selection input:checked"))
            .map(cb => parseInt(cb.value));
        
        document.getElementById("setup").classList.add("hidden");
        document.getElementById("headline").classList.remove("hidden");
        document.getElementById("headline").innerText = `Statistik vs ${opponent}`;

        const playersDiv = document.getElementById("players");
        playersDiv.innerHTML = "";

        selectedPlayers.forEach(num => {
            playersData[num] = {};
            [...actionsPositive, ...actionsNegative].forEach(a => playersData[num][a] = 0);

            const card = document.createElement("div");
            card.className = "player-card";
            card.innerHTML = `<div class="player-name">Spieler ${num}</div>`;

            [...actionsPositive, ...actionsNegative].forEach((a, idx) => {
                const btn = document.createElement("button");
                btn.className = "btn " + (idx < actionsPositive.length ? "positive" : "negative");
                if (a === "TF" && idx >= actionsPositive.length) btn.classList.add("full-width");
                btn.innerText = `${a} (0)`;

                btn.onmousedown = () => {
                    longPressTimer = setTimeout(() => {
                        playersData[num][a] = Math.max(0, playersData[num][a] - 1);
                        btn.innerText = `${a} (${playersData[num][a]})`;
                        updateTables();
                    }, 500);
                };

                btn.onmouseup = () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        playersData[num][a]++;
                        btn.innerText = `${a} (${playersData[num][a]})`;
                        updateTables();
                    }
                };

                btn.onmouseleave = () => clearTimeout(longPressTimer);

                card.appendChild(btn);

                if (idx === actionsPositive.length - 1) {
                    const sep = document.createElement("div");
                    sep.style.borderBottom = "3px solid black";
                    sep.style.margin = "5px 0";
                    card.appendChild(sep);
                }
            });
            playersDiv.appendChild(card);
        });

        updateTables();
    }

    function updateTables() {
        let playerTable = "<table id='playerTable'><thead><tr><th rowspan='2'>Spieler</th>" +
            `<th colspan='${actionsPositive.length}'>Positive Aktionen</th>` +
            `<th colspan='${actionsNegative.length}'>Negative Aktionen</th></tr><tr>` +
            actionsPositive.map(a => `<th>${a}</th>`).join("") +
            actionsNegative.map((a,i) => `<th class='${i===0 ? "thick-separator" : ""}'>${a}</th>`).join("") +
            "</tr></thead><tbody>";

        Object.keys(playersData).forEach(num => {
            playerTable += `<tr><td><b>Spieler ${num}</b></td>` +
                actionsPositive.map(a => `<td>${playersData[num][a]}</td>`).join("") +
                actionsNegative.map((a,i) => `<td class='${i===0 ? "thick-separator" : ""}'>${playersData[num][a]}</td>`).join("") +
                "</tr>";
        });

        playerTable += "</tbody></table>";
        document.getElementById("playerStats").innerHTML = playerTable;

        let teamTable = "<table id='teamTable'><thead><tr><th rowspan='2'>Team</th>" +
            `<th colspan='${actionsPositive.length}'>Positive Aktionen</th>` +
            `<th colspan='${actionsNegative.length}'>Negative Aktionen</th></tr><tr>` +
            actionsPositive.map(a => `<th>${a}</th>`).join("") +
            actionsNegative.map((a,i) => `<th class='${i===0 ? "thick-separator" : ""}'>${a}</th>`).join("") +
            "</tr></thead><tbody>";

        let sums = {};
        [...actionsPositive, ...actionsNegative].forEach(a => sums[a] = 0);
        Object.values(playersData).forEach(p => Object.keys(p).forEach(a => sums[a] += p[a]));

        teamTable += `<tr><td><b>Gesamt</b></td>` +
            actionsPositive.map(a => `<td>${sums[a]}</td>`).join("") +
            actionsNegative.map((a,i) => `<td class='${i===0 ? "thick-separator" : ""}'>${sums[a]}</td>`).join("") +
            "</tr></tbody></table>";

        document.getElementById("teamStats").innerHTML = teamTable;
    }

    function exportTableToExcel(tableID) {
        const table = document.getElementById(tableID);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table, { raw: true });
        XLSX.utils.book_append_sheet(wb, ws, "Stats");
        XLSX.writeFile(wb, `${tableID}.xlsx`);
    }

    function exportTableToPDF(tableID) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("l", "pt", "a4");

        doc.setFontSize(14);
        doc.text("Statistik", 40, 40);

        doc.autoTable({
            html: `#${tableID}`,
            startY: 60,
            theme: "grid",
            headStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: "bold" },
            styles: { halign: "center", fontSize: 10, cellPadding: 3 },
            tableLineWidth: 0.1,
            tableLineColor: 0
        });

        doc.save(`${tableID}.pdf`);
    }
</script>

</body>
</html>
